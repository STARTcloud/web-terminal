name: Development Build

on:
  workflow_call:
    inputs:
      version:
        description: 'Development version to build (optional - auto-calculated if not provided)'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'Development version to build (optional - auto-calculated if not provided)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-development-packages:
    name: Packages
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set development version
        id: version
        run: |
          # Use input version if provided, otherwise auto-calculate
          if [ -n "${{ inputs.version }}" ]; then
            DEV_VERSION="${{ inputs.version }}"
            echo "Using provided version: $DEV_VERSION"
          else
            # Get current version from package.json
            CURRENT_VERSION=$(node -p "require('./package.json').version")

            # Split version into parts
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}

            # Increment patch version for development (no -dev suffix in version)
            NEW_PATCH=$((PATCH + 1))
            DEV_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            
            echo "Current version: $CURRENT_VERSION"
            echo "Auto-calculated development version: $DEV_VERSION"
          fi

          echo "VERSION=$DEV_VERSION" >> $GITHUB_ENV
          echo "PACKAGE_NAME=web-terminal-dev" >> $GITHUB_ENV
          echo "ARCH=amd64" >> $GITHUB_ENV

      # Debian Build Steps
      - name: Checkout for Debian build
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm run cinstall:all

      - name: Build frontend
        run: npm run build

      - name: Remove dev dependencies for packaging
        run: |
          # Remove dev dependencies after building but before packaging
          rm -rf node_modules
          npm run cinstall:backend:nodev
          cd web && rm -rf node_modules && npm run cinstall:nodev

      - name: Create Debian package structure
        run: |
          mkdir -p "${PACKAGE_NAME}_${VERSION}_${ARCH}"/{opt/web-terminal/web,opt/web-terminal,etc/systemd/system,var/lib/web-terminal,var/log/web-terminal,usr/share/man/man8,usr/share/man/man5,DEBIAN}

      - name: Copy application files to Debian package
        run: |
          cp -r models routes middleware config utils packaging app.js package.json "${PACKAGE_NAME}_${VERSION}_${ARCH}/opt/web-terminal/"
          cp -r node_modules "${PACKAGE_NAME}_${VERSION}_${ARCH}/opt/web-terminal/"
          cp -r web/dist "${PACKAGE_NAME}_${VERSION}_${ARCH}/opt/web-terminal/web/dist"
          # Keep public assets for Swagger theming
          cp -r web/public "${PACKAGE_NAME}_${VERSION}_${ARCH}/opt/web-terminal/web/public"

      - name: Copy configuration files to Debian package
        run: |
          cp packaging/DEBIAN/systemd/web-terminal.service "${PACKAGE_NAME}_${VERSION}_${ARCH}/etc/systemd/system/"
          cp packaging/DEBIAN/postinst packaging/DEBIAN/prerm packaging/DEBIAN/postrm "${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/"

      - name: Install man pages
        run: |
          # Copy and compress man pages following Debian Policy
          gzip -9 -c packaging/DEBIAN/man/web-terminal.8 > "${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/man/man8/web-terminal.8.gz"
          gzip -9 -c packaging/DEBIAN/man/web-terminal.yaml.5 > "${PACKAGE_NAME}_${VERSION}_${ARCH}/usr/share/man/man5/web-terminal.yaml.5.gz"

      - name: Create Debian control file
        run: |
          cat > "${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN/control" << EOF
          Package: web-terminal-dev
          Version: ${VERSION}
          Section: misc
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: MarkProminic <MarkProminic@users.noreply.github.com>
          Depends: nodejs (>= 22.0.0), sqlite3, openssl
          Conflicts: web-terminal
          Description: Web-Terminal (Development)
           A secure web-based terminal interface providing shell access through a browser with OIDC authentication and HTTPS encryption.
           This is a development version.
          Homepage: https://github.com/STARTcloud/web-terminal
          EOF

      - name: Set Debian package permissions
        run: |
          find "${PACKAGE_NAME}_${VERSION}_${ARCH}" -type d -exec chmod 755 {} \;
          find "${PACKAGE_NAME}_${VERSION}_${ARCH}" -type f -exec chmod 644 {} \;
          chmod 755 "${PACKAGE_NAME}_${VERSION}_${ARCH}/DEBIAN"/{postinst,prerm,postrm}

      - name: Build Debian package
        run: |
          dpkg-deb --build "${PACKAGE_NAME}_${VERSION}_${ARCH}" "${PACKAGE_NAME}_${VERSION}_${ARCH}.deb"

#      # OmniOS Build Steps
#      - name: Fresh checkout for OmniOS build
#        uses: actions/checkout@v6
#        with:
#          path: omnios-source
#          clean: true
#
#      - name: Clean OmniOS build directory
#        run: |
#          ssh ghrunner@omnios.packages.startcloud.com "rm -rf /local/builds/web-terminal-dev/* /local/builds/web-terminal-dev/.*" || true
#
#      - name: Sync source code to OmniOS
#        run: |
#          rsync -av \
#            --exclude='.git' \
#            --exclude='node_modules' \
#            --exclude='web/node_modules' \
#            --exclude='web/dist' \
#            --exclude='*.deb' \
#            omnios-source/ ghrunner@omnios.packages.startcloud.com:/local/builds/web-terminal-dev/
#
#      - name: Build package on OmniOS
#        run: |
#          ssh ghrunner@omnios.packages.startcloud.com "
#            cd /local/builds/web-terminal-dev && 
#            export PATH=/opt/ooce/bin:/opt/ooce/node-22/bin:\$PATH &&
#            export MAKE=gmake &&
#            export DEV_VERSION=${VERSION} &&
#            chmod +x packaging/omnios/build.sh &&
#            ./packaging/omnios/build.sh
#          "
#
#      - name: Transfer OmniOS package back
#        run: |
#          rsync -av ghrunner@omnios.packages.startcloud.com:/local/builds/web-terminal-dev/*.p5p ./ || echo "No .p5p files found"
#
#      - name: Upload Debian package to repository server
#        run: |
#          rsync -av ${PACKAGE_NAME}_*.deb startcloud@172.17.204.177:/tmp/
#
#      - name: Add package to repository pool
#        run: |
#          ssh startcloud@172.17.204.177 "
#            mkdir -p /local/public/debian/pool/main/z/web-terminal-dev
#            cp /tmp/${PACKAGE_NAME}_*.deb /local/public/debian/pool/main/z/web-terminal-dev/
#          "

      - name: Update repository Packages files for all suites
        run: |
          ssh startcloud@172.17.204.177 "
            cd /local/public/debian
            # Generate Packages files for each suite
            for suite in bookworm trixie; do
              dpkg-scanpackages --arch amd64 pool/ > dists/\$suite/main/binary-amd64/Packages
              gzip -c dists/\$suite/main/binary-amd64/Packages > dists/\$suite/main/binary-amd64/Packages.gz
            done
          "

      - name: Generate Release files for all suites
        run: |
          ssh startcloud@172.17.204.177 "
            cd /local/public/debian
            # Generate Release files for each suite
            for suite in bookworm trixie; do
              cd dists/\$suite
              /local/generate-release.sh \$suite > Release
              cd ../..
            done
          "

      - name: Create stable distribution with proper Release file
        run: |
          ssh startcloud@172.17.204.177 "
            cd /local/public/debian/dists
            rm -rf stable 2>/dev/null || true
            cp -r trixie stable
            cd stable
            /local/generate-release.sh stable > Release
          "

      - name: Sign repository for all suites including stable
        run: |
          ssh startcloud@172.17.204.177 "
            cd /local/public/debian
            # Sign each suite including stable
            for suite in bookworm trixie stable; do
              cd dists/\$suite
              export GNUPGHOME=\$(mktemp -d /local/pgp/pgpkeys-XXXXXX)
              cat /local/pgp/pgp-key.private | gpg --import
              cat Release | gpg --default-key startcloud -abs > Release.gpg
              cat Release | gpg --default-key startcloud -abs --clearsign > InRelease
              rm -rf \$GNUPGHOME
              cd ../..
            done
          "

#      - name: Publish OmniOS package to repository
#        run: |
#          ssh ghrunner@omnios.packages.startcloud.com "
#            cd /local/builds/web-terminal-dev &&
#            pfexec pkgsend publish -d proto -s file:///local/public/r151054/pkg web-terminal.p5m.final &&
#            pfexec pkgrepo refresh -s /local/public/r151054/pkg &&
#            pfexec svcadm restart pkg/server:r151054_STARTcloud
#          "

      - name: Create development draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create or update draft release for development version
          RELEASE_TAG="v${VERSION}-dev"
          RELEASE_TITLE="Development Release ${VERSION}"
          RELEASE_NOTES="üöß **Development Release** üöß

          This is an automated development build from the main branch.

          **Version**: ${VERSION}
          **Build Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Commit**: ${{ github.sha }}

          ‚ö†Ô∏è **Warning**: This is a development release for testing purposes only. Use production releases for stable deployments.

          ## Packages
          - \`web-terminal-dev_${VERSION}_amd64.deb\` - Debian package
          #- \`web-terminal-dev-${VERSION}.p5p\` - OmniOS package"

          # Delete existing dev release if it exists
          gh release delete "$RELEASE_TAG" --yes || true

          # Create new draft release
          gh release create "$RELEASE_TAG" --draft --title "$RELEASE_TITLE" --notes "$RELEASE_NOTES"

      - name: Upload development packages to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="v${VERSION}-dev"

          # Upload Debian package
          gh release upload "$RELEASE_TAG" "${PACKAGE_NAME}_${VERSION}_${ARCH}.deb" --clobber

          ## Upload OmniOS package if it exists
          #for file in *.p5p; do
          #  if [ -f "$file" ]; then
          #    echo "Uploading $file to draft release..."
          #    gh release upload "$RELEASE_TAG" "$file" --clobber
          #  fi
          #done

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: 'development-packages'
          path: |
            *.deb
          #  *.p5p
          retention-days: 30

      - name: Clean up
        run: |
          #ssh ghrunner@omnios.packages.startcloud.com "rm -rf /local/builds/web-terminal-dev/*"
          ssh startcloud@172.17.204.177 "rm -f /tmp/${PACKAGE_NAME}_*.deb"

      - name: Summary
        run: |
          echo "Development packages built and published:"
          echo "- Version: ${VERSION}"
          echo "- Debian package: ${PACKAGE_NAME}_${VERSION}_${ARCH}.deb"
          echo "- Draft release: v${VERSION}-dev"
          echo "- Packages published to repositories"
